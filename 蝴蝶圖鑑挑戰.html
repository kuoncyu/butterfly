<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£è´è¶ 250+ åœ–é‘‘å¤§æŒ‘æˆ° (ç´”æ·¨ç‰ˆ)</title>
    <style>
        :root {
            --primary: #388e3c;
            --secondary: #81c784;
            --accent: #fbc02d;
            --bg: #f1f8e9;
            --text: #37474f;
            --error: #d32f2f;
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(129, 199, 132, 0.2) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 235, 59, 0.2) 0%, transparent 20%);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 650px;
            width: 100%;
            text-align: center;
            position: relative;
            backdrop-filter: blur(5px);
        }

        /* --- ä¸»é¸å–® --- */
        #setup-screen h1 { color: var(--primary); margin-bottom: 5px; text-shadow: 1px 1px 0px #c8e6c9; }
        .subtitle { color: #666; font-size: 0.9em; margin-bottom: 20px; letter-spacing: 1px; }
        
        .tip-box {
            text-align: left;
            font-size: 0.9em;
            background: #fff9c4;
            padding: 15px;
            border-radius: 12px;
            color: #f57f17;
            margin-bottom: 20px;
            border-left: 5px solid var(--accent);
        }

        .menu-btns {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .start-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3em;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.4);
            transition: all 0.2s;
            flex: 1;
            min-width: 150px;
        }
        .start-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(46, 125, 50, 0.5); }
        
        .encyclopedia-btn {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            flex: 1;
            min-width: 150px;
        }
        .encyclopedia-btn:hover { background: #e8f5e9; }

        /* --- åœ–é‘‘é é¢ --- */
        .search-box { position: relative; margin-bottom: 15px; }
        .search-input {
            width: 100%; padding: 12px 40px 12px 15px; border: 2px solid #c5e1a5;
            border-radius: 25px; font-size: 1em; box-sizing: border-box; outline: none;
        }
        .search-input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #888; }

        .encyclopedia-list { text-align: left; height: 60vh; overflow-y: auto; padding-right: 5px; }
        .family-section { margin-bottom: 25px; }
        .family-title { color: var(--primary); border-bottom: 2px solid #c8e6c9; padding-bottom: 5px; margin-bottom: 10px; font-size: 1.1em; }
        .butterfly-tag {
            display: inline-block; background: #fff; padding: 8px 15px; margin: 4px;
            border-radius: 20px; font-size: 0.95em; cursor: pointer; transition: 0.2s;
            border: 1px solid #dcedc8; color: #555; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .butterfly-tag:hover { background: var(--primary); color: white; transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }

        /* --- Modal (å½ˆå‡ºè¦–çª—) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; border-radius: 15px; padding: 20px;
            position: relative; text-align: center; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 1.5em; cursor: pointer; color: #888; background: none; border: none; }
        .modal-img-area {
            width: 100%; min-height: 250px; background: #f5f5f5; border-radius: 10px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .modal-img { max-width: 100%; max-height: 300px; object-fit: contain; }
        .modal-title { color: var(--primary); margin: 5px 0 10px 0; }
        .modal-desc { text-align: left; line-height: 1.6; color: #555; font-size: 0.95em; }

        /* --- éŠæˆ²é é¢ --- */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .img-area {
            position: relative; width: 100%; height: 350px; background: #f5f5f5; border-radius: 12px;
            display: flex; justify-content: center; align-items: center; overflow: hidden; margin-bottom: 5px; border: 1px solid #eee;
        }
        .butterfly-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; transition: opacity 0.3s; }
        .img-license { font-size: 0.75em; color: #999; text-align: right; margin-bottom: 15px; font-style: italic; height: 1.2em; }
        .loading-text {
            position: absolute; color: #777; font-weight: bold; display: flex; flex-direction: column;
            align-items: center; gap: 10px; text-align: center; animation: float 2s ease-in-out infinite;
        }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .net-icon { font-size: 2em; }

        /* å·¥å…·åˆ— */
        .tools { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .tool-btn {
            padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 20px;
            cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 6px; transition: 0.2s; color: #555;
        }
        .tool-btn:hover { background: #f0f0f0; border-color: #bbb; }
        
        /* é¸é …èˆ‡æŒ‰éˆ• */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .opt-btn {
            padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 12px;
            font-size: 1.1em; color: var(--text); cursor: pointer; font-weight: bold; transition: all 0.2s;
        }
        .opt-btn:hover:not(:disabled) { background: #e8f5e9; border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .opt-btn:disabled { opacity: 0.7; cursor: not-allowed; border-color: transparent; }

        .skip-btn {
            width: 100%; margin-top: 20px; padding: 12px; background: #ffe0b2; color: #e65100;
            border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .skip-btn:hover { background: var(--accent); color: white; }

        .feedback {
            margin-top: 25px; padding: 20px; background: #e8f5e9; border-radius: 15px; text-align: left;
            display: none; border-left: 6px solid var(--primary); animation: fadeIn 0.3s ease;
        }
        .feedback.wrong { background: #ffebee; border-left-color: var(--error); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .next-btn { width: 100%; margin-top: 15px; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold; }

        /* æ²è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #c5e1a5; border-radius: 10px; }
    </style>
</head>
<body>

<div id="setup-screen" class="container">
    <h1>ğŸ¦‹ å°ç£è´è¶ 250+ åœ–é‘‘æŒ‘æˆ°</h1>
    <div class="subtitle">v5.4 ç´”æ·¨ç©©å®šç‰ˆ</div>
    
    <div class="tip-box">
        ğŸ’¡ <strong>éŠæˆ²èªªæ˜ï¼š</strong> <br>
        æœ¬éŠæˆ²åŒ…å« <strong>260</strong> ç¨®å°ç£è´è¶ã€‚<br>
        <strong>åœ–é‘‘åŠŸèƒ½ï¼š</strong> å…§å»ºåœ–ç‰‡é è¦½èˆ‡æœå°‹ã€‚<br>
        <strong>ç„¡å¹²æ“¾é«”é©—ï¼š</strong> ç§»é™¤éŸ³æ•ˆåŠŸèƒ½ï¼Œå°ˆæ³¨æ–¼è­˜åˆ¥è´è¶ä¹‹ç¾ã€‚
    </div>

    <div style="background: #f9fbe7; padding: 20px; border-radius: 15px; margin: 20px 0; border: 1px solid #c5e1a5;">
        <label style="font-weight:bold; color:#555;">æœ¬æ¬¡æŒ‘æˆ°é¡Œæ•¸</label>
        <h2 id="q-val-display" style="color:var(--primary); font-size:3em; margin:10px 0;">10</h2>
        <input type="range" id="q-range" min="5" max="100" value="10" oninput="document.getElementById('q-val-display').innerText = this.value" style="width:100%; accent-color:var(--primary);">
        <p style="font-size:0.85em; color:#888;">(å‘å³æ‹–å‹•å¢åŠ é¡Œæ•¸)</p>
    </div>

    <div class="menu-btns">
        <button class="start-btn" onclick="startGame()">â–¶ é–‹å§‹æŒ‘æˆ°</button>
        <button class="encyclopedia-btn" onclick="openEncyclopedia()">ğŸ“– è´è¶åœ–é‘‘</button>
    </div>
</div>

<div id="encyclopedia-screen" class="container" style="display:none;">
    <div class="header">
        <button onclick="closeEncyclopedia()" style="border:none; background:none; cursor:pointer; font-size:1.2em; color:#666;">â¬… å›ä¸»é¸å–®</button>
        <h2 style="margin:0; color:var(--primary);">ğŸ“– è´è¶åˆ†é¡åœ–é‘‘</h2>
        <div style="width: 24px;"></div>
    </div>
    
    <div class="search-box">
        <input type="text" id="search-input" class="search-input" placeholder="è¼¸å…¥è´è¶åç¨±æœå°‹..." oninput="filterEncyclopedia()">
        <span class="search-icon">ğŸ”</span>
    </div>

    <div id="encyclopedia-content" class="encyclopedia-list">
        </div>
</div>

<div id="detail-modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal(event)">Ã—</button>
        <div class="modal-img-area">
            <div id="modal-loader" class="loading-text" style="display:none;">
                <div class="net-icon">ğŸ•¸ï¸</div>
                <span>è®€å–è³‡æ–™ä¸­...</span>
            </div>
            <img id="modal-img" class="modal-img" src="" alt="è´è¶ç…§ç‰‡" style="display:none;">
        </div>
        <h2 id="modal-title" class="modal-title"></h2>
        <div id="modal-desc" class="modal-desc"></div>
        <button class="tool-btn" style="width:100%; margin-top:15px; justify-content:center;" onclick="searchGoogleFromModal()">
            ğŸ” åœ¨ Google æŸ¥çœ‹æ›´å¤šåœ–ç‰‡
        </button>
    </div>
</div>

<div id="game-screen" class="container" style="display:none;">
    <div class="header">
        <button onclick="confirmExit()" style="border:none; background:none; cursor:pointer; font-size:1.5em;" title="å›åˆ°é¦–é ">ğŸ </button>
        <div style="font-weight:bold; font-size:1.1em;">ç¬¬ <span id="cur-q" style="color:var(--primary);">1</span> / <span id="total-q">10</span> é¡Œ</div>
        <div style="background:var(--primary); color:white; padding:5px 15px; border-radius:20px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
            <span id="score">0</span> åˆ†
        </div>
    </div>

    <div class="img-area">
        <div class="loading-text" id="loader">
            <div class="net-icon">ğŸ•¸ï¸</div>
            <span>è´è¶æ•æ‰ä¸­...</span>
        </div>
        <img id="quiz-img" class="butterfly-img" alt="è´è¶ç…§ç‰‡">
    </div>
    <div id="img-license" class="img-license"></div>

    <div class="tools">
        <button class="tool-btn" onclick="retryWikiImage()" title="é‡æ–°è¼‰å…¥åœ–ç‰‡">
            ğŸ”„ åˆ·æ–°åœ–ç‰‡
        </button>
        <button class="tool-btn" onclick="openGoogleSearch()" title="é–‹å•Ÿ Google åœ–ç‰‡æœå°‹">
            ğŸ” Google æœåœ–
        </button>
    </div>

    <div id="options-area" class="options-grid"></div>

    <button id="skip-btn" class="skip-btn" onclick="skipQuestion()">é€™é¡Œå¤ªé›£äº†ï¼Œè·³é¡Œä¸è¨ˆåˆ†</button>

    <div id="feedback" class="feedback">
        <h3 id="result-title" style="margin:0 0 10px 0;"></h3>
        <p id="result-desc" style="line-height:1.6; font-size:0.95em; color:#444;"></p>
        <button class="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ âœ</button>
    </div>
</div>

<div id="end-screen" class="container" style="display:none;">
    <h1 style="color:var(--primary);">ğŸ† æŒ‘æˆ°çµæŸ</h1>
    <p style="color:#666;">æ‚¨çš„æœ€çµ‚å¾—åˆ†</p>
    <div style="font-size:5em; color:var(--primary); font-weight:bold; margin:10px 0; text-shadow: 2px 2px 0px #c8e6c9;">
        <span id="final-score">0</span>
    </div>
    <p id="end-comment" style="color:#555; font-size:1.2em; margin-bottom:30px;"></p>
    <button class="start-btn" onclick="resetGame()">ğŸ”„ å†æ¬¡æŒ‘æˆ°</button>
</div>

<script>
    // --- ğŸ¦‹ è´è¶è³‡æ–™åº« ---
    const butterflyData = {
        "é³³è¶ç§‘ Papilionidae": [
            "å¤§é³³è¶", "å¯¬å°¾é³³è¶", "ç‰å¸¶é³³è¶", "ç´…ç´‹é³³è¶", "é’å¸¶é³³è¶", "ç„¡å°¾é³³è¶", "çƒé´‰é³³è¶", "é»‘é³³è¶", 
            "å°ç£é³³è¶", "å¤§ç™½ç´‹é³³è¶", "æ›™é³³è¶", "ç å…‰é³³è¶", "é»ƒè£³é³³è¶", "å°ç£å¯¬å°¾é³³è¶", "æ–‘é³³è¶", "é’æ–‘é³³è¶",
            "æœ¨è˜­é’é³³è¶", "ç¶ æ–‘é³³è¶", "å‡å¤©é³³è¶", "åŠé³³è¶", "é»‘å°¾åŠé³³è¶", "é»ƒæ˜Ÿé³³è¶", "æŸ‘æ©˜é³³è¶", 
            "å¤šå§¿éºé³³è¶", "é•·å°¾éºé³³è¶", "éºé³³è¶", "ç´…æ–‘éºé³³è¶", "å°ç£éºé³³è¶", "ç‰ç’ƒç´‹é³³è¶", "ç™½ç´‹é³³è¶", "ç„¡å°¾ç™½ç´‹é³³è¶"
        ],
        "ç²‰è¶ç§‘ Pieridae": [
            "ç´‹ç™½è¶", "å°ç£ç´‹ç™½è¶", "ç«¯ç´…è¶", "å°ç£é»ƒè¶", "è·æ°é»ƒè¶", "æ·¡é»ƒè¶", "æ°´é’ç²‰è¶", "æ©™ç«¯ç²‰è¶",
            "ç•°è‰²å°–ç²‰è¶", "é›²ç´‹å°–ç²‰è¶", "ç´…é»ç²‰è¶", "é·ç²‰è¶", "æ˜Ÿç²‰è¶", "é‹¸ç²‰è¶", "é«˜å±±ç²‰è¶", "æ–‘ç²‰è¶",
            "ç™½ç²‰è¶", "ç·£é»ç™½ç²‰è¶", "é»‘é»ç²‰è¶", "é›²ç²‰è¶", "çº–ç²‰è¶", "è·¯æ˜“æ°ç´…é»ç²‰è¶", "é›Œç™½é»ƒè¶", "è§’ç¿…é»ƒè¶",
            "ç«¯é»‘é»ƒè¶", "æ±Ÿå´é»ƒè¶", "æ˜Ÿé»ƒè¶", "åœ“ç¿…é‰¤ç²‰è¶", "æ¹˜å—å…­è§’æ¡ƒè‰²æ¯"
        ],
        "è›ºè¶ç§‘ Nymphalidae": [
            "æ¯è‘‰è¶", "çŸ³ç‰†è¶", "å­”é›€è›ºè¶", "å¤§ç´…è›ºè¶", "å°ç´…è›ºè¶", "æ¨ºæ–‘è¶", "å¤§ç™½æ–‘è¶", "é’æ–‘è¶",
            "å°é’æ–‘è¶", "ç‰çƒé’æ–‘è¶", "å§¬å°ç´‹é’æ–‘è¶", "ç´«æ–‘è¶", "ç«¯ç´«æ–‘è¶", "åœ“ç¿…ç´«æ–‘è¶", "æ–¯æ°ç´«æ–‘è¶", "å°ç´«æ–‘è¶",
            "è±¹ç´‹è¶", "ç´…æ“¬è±¹æ–‘è¶", "é»ƒè¥Ÿè›ºè¶", "çœ¼è›ºè¶", "é’çœ¼è›ºè¶", "ç¾çœ¼è›ºè¶", "ç‰çƒä¸‰ç·šè¶", "å°ç£ä¸‰ç·šè¶",
            "å¹³å±±ä¸‰ç·šè¶", "å–®å¸¶è›ºè¶", "é›™å°¾è›ºè¶", "å°ç£é›™å°¾è›ºè¶", "ç™½è£™å¼„è¶", "é»‘è„ˆæ¨ºæ–‘è¶", "çµ¹æ–‘è¶",
            "è™æ–‘è¶", "å¤§ç´«è›ºè¶", "æ–è±¹è›ºè¶", "çºè›ºè¶", "ç´…é‹¸è›ºè¶", "ç™½è£³è²“è›ºè¶", "æµæ˜Ÿè›ºè¶",
            "å°ç£å°ç´«è›ºè¶", "å°ç£ç¶ è›ºè¶", "çª„å¸¶ç¿ è›ºè¶", "ç´…æ–‘è„ˆè›ºè¶", "å°ç´«è›ºè¶", "æ•£ç´‹ç››è›ºè¶", "èŠ±ç’°è¶", 
            "å°ç£é»ƒæ–‘è›ºè¶", "ç®­ç’°è¶", "æ°¸æ¾¤é»ƒæ–‘å»•è¶", "å¤§å¹½çœ¼è¶", "åˆ‡ç¿…çœ‰çœ¼è¶", "å°æ³¢ç´‹è›‡ç›®è¶", "å¤§æ³¢ç´‹è›‡ç›®è¶", 
            "å°ç£æ³¢ç´‹è›‡ç›®è¶", "å¯†ç´‹æ³¢çœ¼è¶", "æ±Ÿå´æ³¢çœ¼è¶", "ç™½å¸¶æ³¢çœ¼è¶", "å¯¶å³¶æ³¢çœ¼è¶", "å°ç£é»‘è”­è¶", "ç‰å±±è”­è¶", 
            "ç™½æ¢æ–‘è”­è¶", "è¤ç¿…è”­è¶", "é»‘æ¨¹è”­è¶", "æ¨¹è”­è¶", "å°è›‡ç›®è¶", "å§¬è›‡ç›®è¶", "å¤§é»‘æ˜Ÿå¼„è¶",
            "å°ç£æ˜Ÿä¸‰ç·šè¶", "é‡‘ä¸‰ç·šè¶", "è“¬èŠç’°è›ºè¶", "è±†ç’°è›ºè¶", "å°ç’°è›ºè¶", "æ–·ç·šç’°è›ºè¶", "ç´°å¸¶ç’°è›ºè¶",
            "èµ¤è›ºè¶", "å§¬ç´…è›ºè¶", "é»ƒé‰¤è›ºè¶", "çªå°¾é‰¤è›ºè¶", "ç™½è›ºè¶", "é›»è›ºè¶", "æµ·è±¹è›ºè¶"
        ],
        "å°ç°è¶ç§‘ Lycaenidae": [
            "æ²–ç¹©å°ç°è¶", "å°ç£ç‰ç’ƒå°ç°è¶", "å°ç£ç„ç°è¶", "å°ç£é»‘ç‡•å°ç°è¶", "æ†æ˜¥å°ç°è¶", "ç‡•è—ç°è¶",
            "æ³¢ç´‹å°ç°è¶", "è±†æ³¢ç°è¶", "è˜‡éµå°ç°è¶", "å¢¾ä¸å°ç°è¶", "ç´«æ—¥ç°è¶", "ç´…é‚Šé»ƒå°ç°è¶",
            "ç™½æ³¢ç´‹å°ç°è¶", "ç‰ç’ƒæ³¢ç´‹å°ç°è¶", "æ·¡é’é›…æ³¢ç°è¶", "ç™½æ°´çš„å°ç°è¶", "å§¬ä¸‰å°¾å°ç°è¶",
            "é›™å°¾ç‰ç’ƒå°ç°è¶", "ç³ç°è¶", "ç¶ åº•å°ç°è¶", "å°ç£ç¶ åº•å°ç°è¶", "éœ§ç¤¾ç¶ å°ç°è¶", "å¤¸çˆ¶ç¶ å°ç°è¶",
            "æ‹‰æ‹‰å±±ç¶ å°ç°è¶", "å°ç£çƒå°ç°è¶", "è“¬èŠçƒå°ç°è¶", "ç™½åº•çƒå°ç°è¶", "æ£‹çŸ³å°ç°è¶",
            "å°ç£å–®å¸¶è›ºè¶", "åŸ”é‡Œç‰ç’ƒå°ç°è¶", "æ‰è°·ç‰ç’ƒå°ç°è¶", "ç´°é‚Šç‰ç’ƒå°ç°è¶", "é”é‚¦ç‰ç’ƒå°ç°è¶",
            "æ—¥æœ¬ç´«ç°è¶", "ç‡•å°¾ç´«ç°è¶", "å‡¹ç¿…ç´«ç°è¶", "å°ç£éŠ€ç°è¶", "éŠ€ç°è¶", "è“¬èŠéŠ€ç°è¶",
            "å°ç£ç‘ç°è¶", "ä¸‰å°¾å°ç°è¶", "æ†æ˜¥å§¬å°ç°è¶", "å—æ–¹å§¬å°ç°è¶", "è§’ç´‹å°ç°è¶", "é»‘æ˜Ÿå°ç°è¶"
        ],
        "å¼„è¶ç§‘ Hesperiidae": [
            "ç«¹ç´…å¼„è¶", "å¯¬é‚Šæ©™æ–‘å¼„è¶", "é»‘æ˜Ÿå¼„è¶", "å°ç£ç‘Ÿå¼„è¶", "å°é»‘æ˜Ÿå¼„è¶",
            "å§¬å–®å¸¶å¼„è¶", "å°ç£å–®å¸¶å¼„è¶", "ç‰å¸¶å¼„è¶", "ç™½å¼„è¶", "ç¶ å¼„è¶", "å¤§ç¶ å¼„è¶", "è¤å¼„è¶",
            "å°ç£é»ƒæ–‘å¼„è¶", "é¦™è•‰å¼„è¶", "æ²–ç¹©çµ¨æ¯›å¼„è¶", "å°ç£çµ¨æ¯›å¼„è¶", "å°–ç¿…å¼„è¶", "å¤§ç™½è£™å¼„è¶",
            "åŸ”é‡Œç´…å¼„è¶", "ç†±å¸¶ç™½è£™å¼„è¶", "ç„¡å°¾ç™½è£™å¼„è¶", "é»‘å¼„è¶", "ç™½ç´‹é»‘å¼„è¶", "å°ç£çª—å¼„è¶",
            "é¸è¤å¼„è¶", "é»ƒç´‹å­”å¼„è¶", "å·¨å¼„è¶", "é•·ç‰™å¼„è¶", "å°ç£æµæ˜Ÿå¼„è¶"
        ]
    };

    let fullButterflyList = [];
    Object.values(butterflyData).forEach(list => {
        fullButterflyList = fullButterflyList.concat(list);
    });
    const uniqueButterflies = [...new Set(fullButterflyList)];

    document.getElementById('q-range').max = uniqueButterflies.length;

    // --- åœ–é‘‘ç³»çµ± ---
    function openEncyclopedia() {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('encyclopedia-screen').style.display = 'block';
        if (document.getElementById('encyclopedia-content').innerHTML.trim() === "") {
            renderEncyclopedia();
        }
    }

    function closeEncyclopedia() {
        document.getElementById('encyclopedia-screen').style.display = 'none';
        document.getElementById('setup-screen').style.display = 'block';
    }

    function renderEncyclopedia() {
        const content = document.getElementById('encyclopedia-content');
        content.innerHTML = "";

        for (const [family, list] of Object.entries(butterflyData)) {
            const section = document.createElement('div');
            section.className = 'family-section';
            
            const title = document.createElement('h3');
            title.className = 'family-title';
            title.innerText = family;
            section.appendChild(title);

            list.forEach(name => {
                const tag = document.createElement('span');
                tag.className = 'butterfly-tag';
                tag.innerText = name;
                tag.onclick = () => showButterflyDetail(name);
                section.appendChild(tag);
            });
            content.appendChild(section);
        }
    }

    function filterEncyclopedia() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const sections = document.querySelectorAll('.family-section');

        sections.forEach(section => {
            const tags = section.querySelectorAll('.butterfly-tag');
            let hasVisibleTag = false;
            tags.forEach(tag => {
                if (tag.innerText.toLowerCase().includes(query)) {
                    tag.style.display = 'inline-block';
                    hasVisibleTag = true;
                } else {
                    tag.style.display = 'none';
                }
            });
            section.style.display = hasVisibleTag ? 'block' : 'none';
        });
    }

    // --- Modal é‚è¼¯ ---
    async function showButterflyDetail(name) {
        const modal = document.getElementById('detail-modal');
        const loader = document.getElementById('modal-loader');
        const img = document.getElementById('modal-img');
        const title = document.getElementById('modal-title');
        const desc = document.getElementById('modal-desc');

        modal.style.display = 'flex';
        title.innerText = name;
        desc.innerText = "";
        img.style.display = 'none';
        loader.style.display = 'flex';

        const data = await getWikiData(name);
        loader.style.display = 'none';
        
        if (data && data.img) {
            img.src = data.img;
            img.style.display = 'block';
        } else {
            loader.style.display = 'flex';
            loader.innerHTML = `<span>æš«ç„¡åœ–ç‰‡</span>`;
        }
        desc.innerHTML = (data && data.extract) ? data.extract : "æš«ç„¡è©³ç´°ä»‹ç´¹ã€‚";
    }

    function closeModal(e) {
        if (e.target === document.getElementById('detail-modal') || e.target.classList.contains('modal-close')) {
            document.getElementById('detail-modal').style.display = 'none';
        }
    }

    function searchGoogleFromModal() {
        const name = document.getElementById('modal-title').innerText;
        window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(name + " è´è¶")}`, '_blank');
    }

    // --- é€šç”¨ Wiki API ---
    async function getWikiData(keyword) {
        const apiUrl = `https://zh.wikipedia.org/w/api.php?action=query&titles=${keyword}&prop=pageimages|extracts&format=json&pithumbsize=600&exintro=1&explaintext=1&origin=*&redirects=1`;
        try {
            const res = await fetch(apiUrl);
            const data = await res.json();
            const pages = data.query.pages;
            const pageId = Object.keys(pages)[0];
            if (pageId === "-1") return null;

            const page = pages[pageId];
            return {
                img: page.thumbnail ? page.thumbnail.source : null,
                extract: page.extract
            };
        } catch (e) {
            console.error(e);
            return null;
        }
    }

    // --- éŠæˆ²é‚è¼¯ ---
    let gameState = {
        questions: [],
        index: 0,
        score: 0,
        currentName: "",
        currentWikiData: null,
        imgSrc: "",
        retryCount: 0
    };

    function confirmExit() {
        if(confirm("ç¢ºå®šè¦å›åˆ°é¦–é å—ï¼Ÿç›®å‰çš„é€²åº¦å°‡æœƒéºå¤±ã€‚")) {
            resetGame();
        }
    }

    function resetGame() {
        document.getElementById('setup-screen').style.display = 'block';
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('end-screen').style.display = 'none';
        gameState.score = 0;
    }

    function startGame() {
        const count = parseInt(document.getElementById('q-range').value);
        const shuffled = [...uniqueButterflies].sort(() => 0.5 - Math.random());
        gameState.questions = shuffled.slice(0, count);
        gameState.index = 0;
        gameState.score = 0;
        gameState.retryCount = 0;

        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        document.getElementById('total-q').innerText = count;
        
        loadQuestion();
    }

    async function loadQuestion() {
        if (gameState.index >= gameState.questions.length) {
            endGame();
            return;
        }

        const qName = gameState.questions[gameState.index];
        gameState.currentName = qName;
        gameState.currentWikiData = null;
        gameState.imgSrc = "";

        // UI Reset
        document.getElementById('cur-q').innerText = gameState.index + 1;
        document.getElementById('score').innerText = gameState.score;
        document.getElementById('feedback').style.display = 'none';
        document.getElementById('skip-btn').style.display = 'none';
        document.getElementById('options-area').innerHTML = '';
        document.getElementById('img-license').innerText = '';
        
        const imgEl = document.getElementById('quiz-img');
        const loader = document.getElementById('loader');
        
        imgEl.style.display = 'none';
        imgEl.src = ''; 
        loader.style.display = 'flex';
        loader.innerHTML = '<div class="net-icon">ğŸ•¸ï¸</div><span>è´è¶æ•æ‰ä¸­...</span>';
        
        const data = await getWikiData(qName);

        if (!data || !data.img) {
            gameState.retryCount++;
            if (gameState.retryCount > 5) {
                alert("ç¶²è·¯ç‹€æ³ä¸ä½³ï¼Œç„¡æ³•ç²å–åœ–ç‰‡ã€‚");
                resetGame();
                return;
            }
            let newButterfly = null;
            for (let i = 0; i < 50; i++) {
                let candidate = uniqueButterflies[Math.floor(Math.random() * uniqueButterflies.length)];
                if (!gameState.questions.includes(candidate)) {
                    newButterfly = candidate;
                    break;
                }
            }
            if (newButterfly) {
                gameState.questions[gameState.index] = newButterfly;
                loadQuestion(); 
            } else {
                endGame();
            }
            return; 
        }

        gameState.retryCount = 0;
        gameState.currentWikiData = data;
        gameState.imgSrc = data.img;

        document.getElementById('img-license').innerText = "åœ–ç‰‡ä¾†æºï¼šç¶­åŸºç™¾ç§‘ (Wikipedia)";
        showImage(gameState.imgSrc);
        
        let options = [qName];
        while (options.length < 4) {
            const randomName = uniqueButterflies[Math.floor(Math.random() * uniqueButterflies.length)];
            if (!options.includes(randomName)) {
                options.push(randomName);
            }
        }
        options.sort(() => 0.5 - Math.random());
        renderOptions(options);
        document.getElementById('skip-btn').style.display = 'block';
    }

    function retryWikiImage() {
        const imgEl = document.getElementById('quiz-img');
        const loader = document.getElementById('loader');
        imgEl.style.display = 'none';
        loader.style.display = 'flex';
        loader.innerHTML = '<div class="net-icon">ğŸ•¸ï¸</div><span>é‡æ–°æ•æ‰ä¸­...</span>';
        setTimeout(() => {
            imgEl.src = gameState.imgSrc + `?t=${new Date().getTime()}`; 
            imgEl.onload = () => { loader.style.display = 'none'; imgEl.style.display = 'block'; };
        }, 500);
    }

    function showImage(src) {
        const imgEl = document.getElementById('quiz-img');
        const loader = document.getElementById('loader');
        imgEl.src = src;
        imgEl.onload = () => { loader.style.display = 'none'; imgEl.style.display = 'block'; imgEl.style.opacity = '1'; };
    }

    function openGoogleSearch() {
        const name = gameState.currentName || ""; 
        window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(name + " è´è¶")}`, '_blank');
    }

    function renderOptions(options) {
        const area = document.getElementById('options-area');
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(btn, opt);
            area.appendChild(btn);
        });
    }

    function checkAnswer(btn, ans) {
        const correct = gameState.currentName;
        const feedback = document.getElementById('feedback');
        
        document.querySelectorAll('.opt-btn').forEach(b => {
            b.disabled = true;
            if (b.innerText === correct) {
                b.style.backgroundColor = '#2e7d32'; b.style.borderColor = '#2e7d32'; b.style.color = 'white';
            } else if (b === btn && ans !== correct) {
                b.style.backgroundColor = '#ffebee'; b.style.borderColor = '#d32f2f'; b.style.color = '#d32f2f';
            }
        });
        document.getElementById('skip-btn').style.display = 'none';
        feedback.style.display = 'block';
        
        if (ans === correct) {
            gameState.score += 10;
            document.getElementById('score').innerText = gameState.score;
            feedback.className = 'feedback';
            document.getElementById('result-title').innerText = "ğŸ‰ æ•æ‰æˆåŠŸï¼";
        } else {
            feedback.className = 'feedback wrong';
            document.getElementById('result-title').innerText = "ğŸ˜… è´è¶é£›èµ°äº†...";
        }
        let intro = gameState.currentWikiData && gameState.currentWikiData.extract ? gameState.currentWikiData.extract.substring(0, 120) + "..." : "ç¶­åŸºç™¾ç§‘æš«ç„¡è©³ç´°èªªæ˜ã€‚";
        document.getElementById('result-desc').innerHTML = `<strong>ã€${correct}ã€‘</strong><br>${intro}`;
    }

    function skipQuestion() {
        const correct = gameState.currentName;
        document.querySelectorAll('.opt-btn').forEach(b => {
            b.disabled = true;
            if (b.innerText === correct) {
                b.style.backgroundColor = '#2e7d32'; b.style.color = 'white';
            }
        });
        document.getElementById('skip-btn').style.display = 'none';
        const feedback = document.getElementById('feedback');
        feedback.style.display = 'block';
        feedback.className = 'feedback';
        document.getElementById('result-title').innerText = "è·³é¡Œ (ä¸è¨ˆåˆ†)";
        let intro = gameState.currentWikiData && gameState.currentWikiData.extract ? gameState.currentWikiData.extract.substring(0, 120) + "..." : "ç¶­åŸºç™¾ç§‘æš«ç„¡è©³ç´°èªªæ˜ã€‚";
        document.getElementById('result-desc').innerHTML = `<strong>ã€${correct}ã€‘</strong><br>${intro}`;
    }

    function nextQuestion() { gameState.index++; loadQuestion(); }

    function endGame() {
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('end-screen').style.display = 'block';
        document.getElementById('final-score').innerText = gameState.score;
        const score = gameState.score;
        const totalScore = gameState.questions.length * 10;
        const msg = document.getElementById('end-comment');
        if (score >= totalScore * 0.9) msg.innerText = "ğŸ¦‹ å¤ªç¥äº†ï¼ä½ æ˜¯è´è¶åšå£«å§ï¼";
        else if (score >= totalScore * 0.6) msg.innerText = "âœ¨ ä¸éŒ¯å–”ï¼å°è´è¶å¾ˆæœ‰ç ”ç©¶ï¼";
        else msg.innerText = "ğŸ’ª å†æ¥å†å²ï¼å¤§è‡ªç„¶åœ¨ç­‰ä½ æ¢ç´¢ï¼";
    }
</script>
</body>
</html>